@page "/fpwVerify/{Username}"
@using LedgrLogic
@inject NavigationManager NavigationManager

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forgot Password — Verify</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Oswald:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="page page--login">

<!-- Header -->
<header class="site-header">
  <div class="container header-inner">
    <img src="/logo-slogan.png" alt="LEDGR — The smart way to balance business" class="brand-logo" />
  </div>
</header>

<!-- Back link -->
<p class="body1">
  <NavLink class="link" href="/fpwIdentify" aria-label="Return to previous page">← Return to Previous Page</NavLink>
</p>

<main class="container" style="max-width:980px;">
  
  <!-- Card -->
  <section class="card" aria-labelledby="verifyTitle" style="max-width:480px; margin:24px auto;">
    <h1 id="verifyTitle" class="h2" style="margin-top:8px;">Verify Your Identity</h1>
    <p class="body1 muted" style="margin-top:0;">Answer your security questions to reset your password.</p>

    @if (Alert != string.Empty)
    {
    <div class="alert">
      <p><strong>@Alert</strong></p>
    </div>
    }
    
    <form id="fpFormVerify" class="form" novalidate>
      <label class="field">
        <span class="field__label">@Questions[0]</span>
        <InputText @bind-Value="UserAnswer1" id="a1" class="input" placeholder="Type your answer." required />
      </label>

      <label class="field">
        <span class="field__label">@Questions[2]</span>
        <InputText @bind-Value="UserAnswer2" id="a2" class="input" placeholder="Type your answer." required />
      </label>

      <label class="field">
        <span class="field__label">@Questions[4]</span>
        <InputText @bind-Value="UserAnswer3" id="a3" class="input" placeholder="Type your answer." required />
      </label>

    <!-- Disabled message for now, interpretation is that it should be on the original password page
      <p class="caption muted">You have 3 attempts before temporary suspension.</p>
    -->
    
      <div class="actions">
        <button @onclick="ClearForm" type="button" class="btn btn--secondary" id="btnSecQClear">Clear</button>
        <button @onclick="VerifyAnswers" type="button" class="btn btn--primary">Verify</button>
        <NavLink href="@($"/fpwReset/{Username}")">To Reset</NavLink>
      </div>
    </form>
  </section>
</main>

</body>
</html>

@code{
  [Parameter] public string Username { get; set; } = string.Empty;
  
  public List<string> Questions { get; set; } = new() { "", "", "", "", "", ""};
  
  public string UserAnswer1 { get; set; } = string.Empty;
  public string UserAnswer2 { get; set; } = string.Empty; 
  public string UserAnswer3 { get; set; } = string.Empty;
  
  public string Answer1 { get; set; } = string.Empty;
  public string Answer2 { get; set; } = string.Empty;
  public string Answer3 { get; set; } = string.Empty;
  
  // Alert Data
  public string Alert { get; set; } = string.Empty;
  
  protected override async Task OnParametersSetAsync()
  {
    User user = await User.GetUserFromUserName(Username);
    Questions = await User.GetSecurityQuestions(user.GetUserID());
    
    Answer1 = Questions[1];
    Answer2 = Questions[3];
    Answer3 = Questions[5];
    
    StateHasChanged();
  }

  public async Task VerifyAnswers()
  {
    if (Answer1 == UserAnswer1 || Answer2 == UserAnswer2 || Answer3 == UserAnswer3)
    {
      NavigationManager.NavigateTo($"/fpwReset/{Username}");
    }
    else
    {
      Alert = "None of the provided answers match those on file";
    }
  }

  public void ClearForm()
  {
    UserAnswer1 = string.Empty;
    UserAnswer2 = string.Empty; 
    UserAnswer3 = string.Empty;
  }
  
  
}